import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

// Market average premiums by employee count (2024-2025 data)
const MARKET_RATES = {
  small: { min: 3500, avg: 5000, max: 7000 }, // 1-50 employees
  medium: { min: 3000, avg: 4500, max: 6000 }, // 51-200 employees
  large: { min: 2500, avg: 4000, max: 5500 } // 200+ employees
};

const SYSTEM_PROMPT = `Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ø¹Ø±ÙˆØ¶ ØªØ£Ù…ÙŠÙ† ØµØ­ÙŠ Ù…ØªØ®ØµØµ ÙˆØ®Ø¨ÙŠØ± ÙÙŠ Ø³ÙˆÙ‚ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ. Ù…Ù‡Ù…ØªÙƒ ØªØ­Ù„ÙŠÙ„ Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„ØµØ­ÙŠ ÙˆÙ…Ù‚Ø§Ø±Ù†ØªÙ‡Ø§ Ø¨Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ù†Ø§ÙØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù…Ù† Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØµØ­ÙŠ.

## Ù…Ø¹Ø±ÙØªÙƒ Ø¨Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©:

### Ø¨ÙˆØ¨Ø§ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Bupa Arabia)
- ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ¦Ø§Øª: Essential 1.0 (Ø£Ø³Ø§Ø³ÙŠ)ØŒ Premium 2.1 (ØªÙ…ÙŠØ²)ØŒ VIP 3.0
- Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…ÙŠÙ†: NW1-NW6 Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
- Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©: Ø´Ø¨ÙƒØ© ÙˆØ§Ø³Ø¹Ø©ØŒ ØªØ·Ø¨ÙŠÙ‚ Ù…ØªÙ…ÙŠØ²ØŒ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©
- Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù: Ø£Ø³Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·ØŒ Ù†Ø³Ø¨ ØªØ­Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©

### Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠØ© (Tawuniya)
- ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ¦Ø§Øª: Essential 1.0ØŒ Premium 2.1ØŒ Executive
- Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…ÙŠÙ†: Ø´Ø¨ÙƒØ© ÙˆØ§Ø³Ø¹Ø© Ù…Ø¹ ØªØºØ·ÙŠØ© Ø¬ØºØ±Ø§ÙÙŠØ© Ù…Ù…ØªØ§Ø²Ø©
- Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©: Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ©ØŒ Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø¹Ø§Ù„ÙŠØ©ØŒ Ø´Ø¨ÙƒØ© Ù…Ù‚Ø¯Ù…ÙŠÙ† ÙƒØ¨ÙŠØ±Ø©
- Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù: Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø£Ø¨Ø·Ø£

### ØªÙƒØ§ÙÙ„ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ (Al Rajhi Takaful)
- Ù…Ù†ØªØ¬ ØªÙƒØ§ÙÙ„ÙŠ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø´Ø±ÙŠØ¹Ø©
- ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ¦Ø§Øª: ÙØ¶ÙŠØŒ Ø°Ù‡Ø¨ÙŠØŒ Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ
- Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©: Ù…Ù†ØªØ¬ ØªÙƒØ§ÙÙ„ÙŠØŒ Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹Ù‚ÙˆÙ„Ø©
- Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù: Ø´Ø¨ÙƒØ© Ù…Ù‚Ø¯Ù…ÙŠÙ† Ø£ØµØºØ± Ù†Ø³Ø¨ÙŠØ§Ù‹

### Ù…ÙŠØ¯ØºÙ„Ù (MedGulf)
- ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ¦Ø§Øª: A, B, C, VIP
- Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©: Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ© Ù„Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØµØºÙŠØ±Ø©
- Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù: Ø´Ø¨ÙƒØ© Ù…Ø­Ø¯ÙˆØ¯Ø© ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚

## Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ù†Ø§ÙØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (CHI):
| Ø§Ù„Ù…Ù†ÙØ¹Ø© | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ | Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡ |
|---------|---------------------|-----------|
| Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ù†ÙØ¹Ø© | 500,000 Ø±ÙŠØ§Ù„ | 500,000 Ø±ÙŠØ§Ù„ |
| ØªØºØ·ÙŠØ© Ø§Ù„ØªÙ†ÙˆÙŠÙ… | Ù…ØºØ·Ù‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ | - |
| Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© | ØªØ­Ù…Ù„ 20% (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 100 Ø±.Ø³) | ØªØ­Ù…Ù„ 20% (Ø­Ø¯ 75 Ø±.Ø³) |
| ØªØ­Ù…Ù„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© | 20% (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 30 Ø±.Ø³) | 20% (Ø­Ø¯ 20 Ø±.Ø³) |
| Ø§Ù„Ø£Ù…ÙˆÙ…Ø© ÙˆØ§Ù„ÙˆÙ„Ø§Ø¯Ø© | 15,000 Ø±ÙŠØ§Ù„ | 25,000 Ø±ÙŠØ§Ù„ |
| Ø§Ù„Ø£Ø³Ù†Ø§Ù† (Ø£Ø³Ø§Ø³ÙŠ) | 1,200 Ø±ÙŠØ§Ù„ | 3,000 Ø±ÙŠØ§Ù„ |
| Ø§Ù„Ø¨ØµØ±ÙŠØ§Øª (Ø£Ù‚Ù„ Ù…Ù† 14 Ø³Ù†Ø©) | Ù…ØºØ·Ù‰ | 1,000 Ø±ÙŠØ§Ù„ |
| Ø§Ù„ØµØ­Ø© Ø§Ù„Ù†ÙØ³ÙŠØ© (Ø­Ø§Ø¯Ø©) | Ù…ØºØ·Ù‰ | 50,000 Ø±ÙŠØ§Ù„ |
| Ø²Ø±Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„Ù‰ | 100,000 Ø±ÙŠØ§Ù„ | 250,000 Ø±ÙŠØ§Ù„ |
| ØºØ³ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù‰ | Ù…ØºØ·Ù‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ | - |
| Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© | Ø­Ø³Ø¨ ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© | - |
| Ø³Ù…Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø°Ù† | 3,000 Ø±ÙŠØ§Ù„ (Ù„Ù„Ø£Ø°Ù†ÙŠÙ†) | 6,000 Ø±ÙŠØ§Ù„ |
| Ø¹Ù„Ø§Ø¬ Ø§Ù„ØªÙˆØ­Ø¯ | 25,000 Ø±ÙŠØ§Ù„ | 50,000 Ø±ÙŠØ§Ù„ |
| Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© | 50,000 Ø±ÙŠØ§Ù„ | 100,000 Ø±ÙŠØ§Ù„ |
| Ø§Ù„Ø³Ù…Ù†Ø© Ø§Ù„Ù…ÙØ±Ø·Ø© | 15,000 Ø±ÙŠØ§Ù„ (ØªØ­Ù…Ù„ 20%) | - |
| Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø²Ù‡Ø§ÙŠÙ…Ø± | 15,000 Ø±ÙŠØ§Ù„ | - |
| Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„ØµÙ…Ø§Ù…ÙŠØ© | 100,000 Ø±ÙŠØ§Ù„ | 150,000 Ø±ÙŠØ§Ù„ |
| Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ø«Ù…Ø§Ù† | 10,000 Ø±ÙŠØ§Ù„ | - |

## Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„:

### 1ï¸âƒ£ Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø±Ø¶
- Ø´Ø±ÙƒØ© Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙˆÙ†ÙˆØ¹ Ø§Ù„ÙØ¦Ø©
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ù… (Ø£Ø³Ø§Ø³ÙŠ/Ù…Ø¹Ø§Ù„ÙŠÙ†)
- Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø³Ù†ÙˆÙŠ ÙˆØªÙƒÙ„ÙØ© Ø§Ù„ÙØ±Ø¯
- Ù…Ø¯Ø© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
- Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹/Ø§Ù„Ø¹Ø±Ø¶

### 2ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±
- Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³ÙˆÙ‚
- ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ±Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (PMPM)
- ØªÙ‚ÙŠÙŠÙ…: Ù…Ù†Ø®ÙØ¶ âœ… | Ù…ØªÙˆØ³Ø· âšª | Ù…Ø±ØªÙØ¹ ğŸ”´

### 3ï¸âƒ£ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†Ø§ÙØ¹
Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø±Ù…ÙˆØ²:
- âœ… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ
- â¬†ï¸ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©)
- âš ï¸ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø£Ùˆ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚
- âŒ ØºÙŠØ± Ù…ØºØ·Ù‰ (Ù…Ø®Ø§Ù„ÙØ© Ù…Ø­ØªÙ…Ù„Ø©)

### 4ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù‚Ø¯Ù…ÙŠÙ†
- ØªØºØ·ÙŠØ© Ø¬ØºØ±Ø§ÙÙŠØ© (Ù…Ù…ØªØ§Ø²Ø©/Ø¬ÙŠØ¯Ø©/Ù…Ø­Ø¯ÙˆØ¯Ø©)
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª
- ØªÙˆÙØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰
- Ù†ÙˆØ¹ Ø§Ù„ÙˆØµÙˆÙ„ (Ù…Ø¨Ø§Ø´Ø±/Ø¥Ø­Ø§Ù„Ø©)

### 5ï¸âƒ£ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©
- Ø§Ù„Ù…Ù†Ø§ÙØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
- Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ­Ù…Ù„
- Ø®Ø¯Ù…Ø§Øª Ù…Ø¶Ø§ÙØ©

### 6ï¸âƒ£ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù ÙˆØ§Ù„ØªÙØ§ÙˆØ¶
- Ù…Ù†Ø§Ø·Ù‚ ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†
- Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªÙØ§ÙˆØ¶ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©

### 7ï¸âƒ£ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªØ±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¯ÙˆÙ† Ø²ÙŠØ§Ø¯Ø© Ø³Ø¹Ø±ÙŠØ©
Ù‚Ø¯Ù… 5-7 Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù…Ù„ÙŠØ© Ù…Ø«Ù„:
- ØªÙˆØ³ÙŠØ¹ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù‚Ø¯Ù…ÙŠÙ† ÙÙŠ Ù…Ù†Ø§Ø·Ù‚ Ù…Ø­Ø¯Ø¯Ø©
- Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© (Ø§Ù„Ø³ÙƒØ±ÙŠ/Ø§Ù„Ø¶ØºØ·)
- ØªÙ‚Ù„ÙŠÙ„ Ù†Ø³Ø¨ Ø§Ù„ØªØ­Ù…Ù„ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© (ØªÙƒÙ„ÙØ© Ù…Ù†Ø®ÙØ¶Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©)
- Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø§Ù„Ø·Ø¨ Ø¹Ù† Ø¨Ø¹Ø¯
- ØªØ­Ø³ÙŠÙ† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
- ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª
- Ø¥Ø¶Ø§ÙØ© Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª
- Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø¹Ø§ÙÙŠØ© ÙˆØ§Ù„Ø±ÙŠØ§Ø¶Ø©

### 8ï¸âƒ£ ØªÙˆØµÙŠØ§Øª Ø§Ù„ØµØ­Ø© Ø§Ù„Ø³ÙƒØ§Ù†ÙŠØ©
Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ÙˆØªØ­Ø³ÙŠÙ† ØµØ­Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:
- Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©
- ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
- Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØµØ­Ø© Ø§Ù„Ù†ÙØ³ÙŠØ©

### 9ï¸âƒ£ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
| Ø§Ù„Ù…Ø¹ÙŠØ§Ø± | Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ù…Ù† 10) |
|---------|----------------|
| Ø§Ù„Ø³Ø¹Ø± | X/10 |
| Ø§Ù„ØªØºØ·ÙŠØ© | X/10 |
| Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù‚Ø¯Ù…ÙŠÙ† | X/10 |
| Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ | X/10 |
| **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ** | **X/10** |

### ğŸ¯ Ø§Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
Ù‚Ø¯Ù… ØªÙˆØµÙŠØ© ÙˆØ§Ø¶Ø­Ø©: Ù‡Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù‚Ø¨ÙˆÙ„/ÙŠØ­ØªØ§Ø¬ ØªÙØ§ÙˆØ¶/ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨

---
Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ùƒ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù… ÙˆÙ…Ø®ØªØµØ±. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø±Ù…ÙˆØ² Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.`;

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { pdfBase64, fileName, employeeCount, language = 'ar' } = await req.json();
    
    if (!pdfBase64) {
      console.error("No PDF file provided");
      return new Response(
        JSON.stringify({ error: "No PDF file provided" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    if (!LOVABLE_API_KEY) {
      console.error("LOVABLE_API_KEY is not configured");
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // Determine market rate category
    let marketCategory = "small";
    if (employeeCount > 200) marketCategory = "large";
    else if (employeeCount > 50) marketCategory = "medium";
    
    const marketRates = MARKET_RATES[marketCategory as keyof typeof MARKET_RATES];

    console.log(`Analyzing PDF quote: ${fileName} for ${employeeCount || 'unknown'} employees, market category: ${marketCategory}`);

    const userPrompt = `Ø­Ù„Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ Ø§Ù„Ù…Ø±ÙÙ‚ ÙÙŠ Ù…Ù„Ù PDF Ø¨Ø´ÙƒÙ„ Ø´Ø§Ù…Ù„.

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:
- Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${fileName || 'Ø¹Ø±Ø¶ ØªØ£Ù…ÙŠÙ†ÙŠ'}
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${employeeCount || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
- Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³ÙˆÙ‚ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© (${employeeCount > 200 ? 'ÙƒØ¨ÙŠØ±Ø©' : employeeCount > 50 ? 'Ù…ØªÙˆØ³Ø·Ø©' : 'ØµØºÙŠØ±Ø©'}): 
  - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: ${marketRates.min} Ø±ÙŠØ§Ù„/ÙØ±Ø¯/Ø³Ù†Ø©
  - Ø§Ù„Ù…ØªÙˆØ³Ø·: ${marketRates.avg} Ø±ÙŠØ§Ù„/ÙØ±Ø¯/Ø³Ù†Ø©
  - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰: ${marketRates.max} Ø±ÙŠØ§Ù„/ÙØ±Ø¯/Ø³Ù†Ø©

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…ÙØµÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù„ØºØ© ${language === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'} Ù…ØªØ¨Ø¹Ø§Ù‹ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯.

Ø§Ø³ØªØ®Ø±Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ:
- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙØ¹ ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯
- Ù†Ø³Ø¨ Ø§Ù„ØªØ­Ù…Ù„
- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù‚Ø¯Ù…ÙŠÙ†
- Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø·
- Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª`;

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: SYSTEM_PROMPT },
          { 
            role: "user", 
            content: [
              {
                type: "file",
                file: {
                  filename: fileName || "quote.pdf",
                  file_data: `data:application/pdf;base64,${pdfBase64}`
                }
              },
              {
                type: "text",
                text: userPrompt
              }
            ]
          }
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        console.error("Rate limit exceeded");
        return new Response(
          JSON.stringify({ error: "Rate limit exceeded. Please try again later." }),
          { status: 429, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
      if (response.status === 402) {
        console.error("Payment required");
        return new Response(
          JSON.stringify({ error: "Payment required. Please add credits to your workspace." }),
          { status: 402, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      return new Response(
        JSON.stringify({ error: "AI gateway error: " + errorText }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log("Successfully started streaming response for PDF analysis");
    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (e) {
    console.error("analyze-quote error:", e);
    return new Response(
      JSON.stringify({ error: e instanceof Error ? e.message : "Unknown error" }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
